# v1.9.4 版本更新

## 更新内容

### 功能更新
- **Workflow**: 增加流程快照机制。解决历史工单在流程定义更新后，无法正确查看当时流程图的问题。
- **Workflow**: 流程发布时自动创建快照。
- **Incr**: 提供 v1.9.4 数据迁移脚本，用于为现存的已发布流程补全快照数据。

### 数据库变更
- **MongoDB**: 新增 `c_workflow_snapshot` 集合，用于存储流程定义的历史快照数据。
- **数据迁移**: 
    - 遍历 `c_workflow` 表中所有 `process_id > 0` 的流程定义。
    - 关联查询 MySQL `proc_def` 表获取当前最新版本号。
    - 检查 `c_workflow_snapshot`，若不存在对应版本的快照，则基于当前 `c_workflow` 数据自动生成一份。

### API 变更
- 无破坏性变更。`WorkflowService.FindInstanceFlow` 内部实现已调整为优先读取快照。

### 配置变更
- 无。

## 升级说明

### 前置条件
- 当前版本建议 >= v1.9.3。
- 建议在低峰期执行升级操作。

### 升级步骤
1. 执行数据备份（MongoDB `c_workflow` 和 MySQL `proc_def`）。
2. 执行 `initial` 命令进行版本升级与数据迁移（会自动执行 `v1.9.4` 的 `Commit` 逻辑）。
3. 验证 `c_workflow_snapshot` 表中是否已生成数据。
4. 部署新版应用代码。

### 回滚说明
如果升级失败，数据迁移脚本不会破坏原始 `c_workflow` 数据，仅涉及新表插入。
1. 回滚应用代码。
2. （可选）清理 `c_workflow_snapshot` 表中新生成的数据（不清理也不会影响旧版运行）。

## 注意事项
- 升级脚本使用了批量查询和插入（Batch Size = 200），对数据库压力较小。
- 脚本具有幂等性，多次执行不会重复创建相同的快照。

## 测试验证
- [x] 功能测试通过：新流程发布生成快照。
- [x] 功能测试通过：历史工单查看流程图正确降级使用快照。
- [x] 数据迁移测试通过：现有数据成功补全快照。
