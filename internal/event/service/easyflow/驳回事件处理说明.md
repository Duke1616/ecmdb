# 工作流驳回事件处理说明

> 文档说明：本文档基于实际业务流程图，详细介绍工作流中与驳回相关的三个核心事件处理器的作用、注册时机和执行逻辑。

<img src="./images/process_flow.png" alt="流程图" width="800" />

*(示意图：包含并行网关、条件网关嵌套及 Proxy 节点的复杂流程)*

---

### 4.3 Proxy 节点的删除

**为什么必须删除而不是修改状态？**

| 方案 | 操作 | 工作流引擎行为 | 结果 |
|------|------|---------------|------|
| 修改状态 | `UPDATE status = 4` | 仍然找到记录 → 判断为"已完成" | ❌ 工作流继续流转（错误） |
| 删除记录 | `DELETE FROM proc_task` | 找不到记录 → 判断为"未完成" | ✅ 工作流正确停止 |

**删除方法（必须精确删除）**：

> ⚠️ **重要提示**：禁止使用 `DeleteProxyNode(procInstId)` 这种全量删除方法！
> 如果并行网关的多条分支都存在 Proxy 节点，全量删除会导致其他正常分支的 Proxy 也被误删。
> 必须先获取特定的 Proxy 节点 ID，然后执行定点删除。

```go
// 1. 获取特定 Proxy 节点
proxyTask := GetProxyTaskByProcessInstId(processInstId)

// 2. 精确删除
DeleteProxyNodeByNodeId(proxyTask.NodeID)

// SQL:
// DELETE FROM proc_task 
// WHERE node_id = ? AND user_id = 'sys_auto'
```

## 核心事件与节点对应关系

基于上图流程，各节点注册的事件如下：

| 节点名称 | 注册事件 | 作用简述 |
|---------|---------|---------|
| **张三 / 李四** | `EventConcurrentRejectCleanup` | 位于并行分支的条件网关内，驳回时清理同级任务。 |
| **王五** | `EventUserNodeRejectProxyCleanup` | 位于并行分支，且兄弟分支包含 Proxy 节点。 |
| **领导** | `EventGatewayConditionReject` | 位于汇聚网关之后，驳回时需处理上游的 Proxy 穿透。 |

---

## 一、EventConcurrentRejectCleanup （并发清理）

### 1.1 作用
当并行/包容网关由于嵌套了条件网关（如上图中的 Start Condition），导致分支内有多个层级时。位于内部的节点（张三/李四）被驳回，需要清理该分支内的兄弟任务状态。

### 1.2 注册场景
- **结构**：Parallel Gateway -> Condition Gateway -> **Me**
- **图中节点**：**张三**、**李四**

### 1.3 执行逻辑
当 **张三** 驳回时：
1. 检查自身状态为驳回。
2. 触发清理逻辑，将该条件网关分支下的其他待办任务（如可能存在的其他并发任务）标记为 `SystemReject`。

---

## 二、EventUserNodeRejectProxyCleanup （Proxy 环境标记/清理）

### 2.1 作用
处理 "兄弟分支有 Proxy" 的场景。当一个普通节点（王五）与一个生成了 Proxy 节点的复杂分支（张三/李四分支）并存时，如果王五驳回，需要感知到 Proxy 节点的存在并进行处理（清理/标记），防止死循环。

### 2.2 注册场景
- **结构**：Parallel Gateway -> **Me** (且 Parallel Gateway 的其他分支包含 Condition Gateway，从而生成了 Proxy)。
- **图中节点**：**王五**

### 2.3 执行逻辑
当 **王五** 驳回时：
1. 系统检测到当前所处的网关环境中，兄弟分支存在系统自动生成的 Proxy 节点。
2. 执行清理逻辑或标记日志（视具体实现版本），确保兄弟分支的 Proxy 节点任务被移除，防止工作流引擎错误地认为 Proxy 分支已完成而强行推进流程。

---

## 三、EventGatewayConditionReject （网关条件驳回/穿透）

### 3.1 作用
这是最复杂的处理器，主要负责解决 **"Proxy 穿透"** 和 **"汇聚点回退"** 的问题。它处理汇聚网关之后的节点驳回。

### 3.2 注册场景
- **结构**：Condition Gateway -> Parallel Gateway (Join) -> **Me**
- **图中节点**：**领导**

### 3.3 执行逻辑
当 **领导** 驳回时，面临两种情况：

#### **情况 A：回退路径遇到 Proxy 节点（穿透）**
假设流程虽然经过了汇聚网关，但上游分支中包含 Proxy 节点（例如张三通过了，生成了 Proxy）。
1. **识别**：领导驳回的前置节点指向了 Proxy 节点。
2. **反查**：事件反查数据库，找到该 Proxy 节点指向的**真实来源**（例如 **张三**）。
3. **穿透**：将领导任务的 `prev_node_id` 篡改为 **张三** 的 ID。
4. **结果**：工作流引擎将驳回路径修正为 `领导 -> 张三`，跳过 Proxy 和网关。

#### **情况 B：清理残留 Proxy**
1. 在修正回退路径的同时，物理删除数据库中已生成的 Proxy 节点任务记录。
2. **目的**：防止 Proxy 节点的状态（已完成）干扰后续流程重新流转，彻底消除脏数据。

---

## 四、总结：驳回流转全景

| 动作 | 触发事件 | 结果 |
|------|---------|------|
| **张三 驳回** | `EventConcurrentRejectCleanup` | 自身分支结束，清理同分支兄弟。 |
| **王五 驳回** | `EventUserNodeRejectProxyCleanup` | 自身驳回，同时清理兄弟分支（张三/李四那边）产生的 Proxy 节点。 |
| **领导 驳回** | `EventGatewayConditionReject` | 1. 穿透 Proxy，直接找 **张三/王五**。<br>2. 删除历史 Proxy 记录。<br>3. 流程回退到具体处理人。 |

> **核心原则**：所有涉及 Proxy 节点的驳回，必须 **"穿透虚拟节点，回归真实业务节点"**，并 **"物理删除 Proxy 记录"** 以防状态污染。
